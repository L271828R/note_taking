#!/usr/bin/env bash

NOTE_DIR="$NOTES_FOLDERS_PATH"
CURRENT_FILE="$NOTES_CURRENT_FILE"
RESULTS_FILE="$NOTES_RESULTS_FILE"

# 1) Make sure NOTE_DIR exists
if [[ ! -d "$NOTE_DIR" ]]; then
  echo "Error: $NOTE_DIR not found." >&2
  exit 1
fi

# 2) Read the first non-blank line from 'current'
current=""
if [[ -f "$CURRENT_FILE" ]]; then
  current=$(sed -n '1s/^[[:space:]]*//;1s/[[:space:]]*$//p' "$CURRENT_FILE")
fi

# 3) Determine the target path
if [[ -n "$current" ]]; then
  TARGET="$NOTE_DIR/$current"
  if [[ ! -d "$TARGET" ]]; then
    echo "Warning: '$current' not found under $NOTE_DIR, listing all .md instead." >&2
    TARGET="$NOTE_DIR"
  fi
else
  TARGET="$NOTE_DIR"
fi

# 4) Gather and enumerate .md files
mapfile -t files < <(
  lsd -1 "$TARGET"/*.md 2>/dev/null \
    | xargs -r -n1 basename \
    | sort
)

# 5) Write enumerated list to results.txt and also print it
{
  for i in "${!files[@]}"; do
    printf "%d. %s\n" $((i+1)) "${files[i]}"
  done
} | tee "$RESULTS_FILE"

