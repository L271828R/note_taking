#!/usr/bin/env bash
#
# ncurrent.sh
# 1) Enumerate .md files (with color in the timestamp)
# 2) Write to $NOTES_RESULTS_FILE
# 3) Invoke plugins in nlist_plugins/
# 4) Print final

# resolve script dir (for finding nlist_plugins/)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

NOTE_DIR="$NOTES_FOLDERS_PATH"
CURRENT_FILE="$NOTES_CURRENT_FILE"
RESULTS_FILE="$NOTES_RESULTS_FILE"
PLUGIN_DIR="$SCRIPT_DIR/nlist_plugins"

# 1) ensure NOTE_DIR exists
if [[ ! -d "$NOTE_DIR" ]]; then
  echo "Error: NOTE_DIR '$NOTE_DIR' not found." >&2
  exit 1
fi

# 2) determine TARGET (possibly a subfolder named by the first line of CURRENT_FILE)
current=""
if [[ -f "$CURRENT_FILE" ]]; then
  current=$(awk 'NR==1 { gsub(/^[ \t]+|[ \t]+$/, ""); print; exit }' "$CURRENT_FILE")
fi
if [[ -n "$current" && -d "$NOTE_DIR/$current" ]]; then
  TARGET="$NOTE_DIR/$current"
else
  TARGET="$NOTE_DIR"
fi

# 3) gather & enumerate .md files (newest first), with color on the date
mapfile -t file_list < <(
  shopt -s nullglob
  for f in "$TARGET"/*.md; do
    [[ -f "$f" ]] || continue
    echo "$(stat -f "%m" "$f")|$(basename "$f")"
  done | sort -nr
)

GREEN='\033[0;32m'
RESET='\033[0m'

{
  for i in "${!file_list[@]}"; do
    IFS='|' read -r epoch name <<< "${file_list[i]}"
    dt=$(date -r "$epoch" "+%Y-%m-%d %H:%M:%S")
    # **THIS** is where the color lives:
    printf "%d. %s ${GREEN}%s${RESET}\n" $((i+1)) "$name" "$dt"
  done
} > "$RESULTS_FILE"

# 4) run each executable plugin (they all get RESULTS_FILE + TARGET)
if [[ -d "$PLUGIN_DIR" ]]; then
  for plugin in "$PLUGIN_DIR"/*.sh; do
    [[ -x "$plugin" ]] || continue
    "$plugin" "$RESULTS_FILE" "$TARGET"
  done
fi

# 5) print it out (with colors intact)
echo ""
echo "$current"
echo "-------------------------------------------------"
cat "$RESULTS_FILE"
echo ""

